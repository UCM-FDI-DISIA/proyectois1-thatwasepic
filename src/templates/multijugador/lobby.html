{% extends "base/base_casino.html" %}

{% block content %}
<div class="simple-background"></div>

<div class="text-center mb-5">
    <h1 class="hero-title">Modo Multijugador</h1>
    <p class="hero-subtitle mt-4">
        Crea o únete a salas para jugar con otros usuarios en tiempo real
    </p>
</div>

<div class="row">
    <!-- Panel de Crear Sala -->
    <div class="col-md-4 mb-4">
        <div class="card hover-card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Crear Sala</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('multijugador.crear_sala') }}">
                    <div class="mb-3">
                        <label class="form-label">Nombre de la Sala</label>
                        <input type="text" class="form-control" name="nombre" required 
                               placeholder="Ej: Torneo Blackjack Pro">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Juego</label>
                        <select class="form-select" name="juego" required id="select-juego" onchange="actualizarCapacidad()">
                            <option value="">Selecciona un juego</option>
                            <option value="coinflip">Coinflip (2 jugadores)</option>
                            <option value="caballos">Carrera de Caballos (4 jugadores)</option>
                            <option value="blackjack">Blackjack (4 jugadores)</option>
                            <option value="poker">Póker (4 jugadores)</option>
                            <option value="ruleta">Ruleta (4 jugadores)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Capacidad</label>
                        <select class="form-select" name="capacidad" id="select-capacidad">
                            <!-- Se actualizará dinámicamente -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Apuesta Mínima</label>
                        <input type="number" class="form-control" name="apuesta_minima" 
                               value="10.0" min="1" step="0.5" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-gamepad me-2"></i>Crear Sala
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lista de Salas Disponibles -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-list me-2"></i>Salas Disponibles</h4>
            </div>
            <div class="card-body">
                {% if salas %}
                <div class="row g-3" id="salas-container">
                    {% for sala in salas %}
                    <div class="col-12">
                        <div class="card hover-card translucent-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5 class="card-title">{{ sala.nombre }}</h5>
                                        <div class="d-flex gap-3 mt-2">
                                            <span class="badge" style="background: var(--gradient-cyber);">
                                                <i class="fas fa-gamepad me-1"></i>{{ sala.juego|title }}
                                            </span>
                                            <span class="badge" style="background: var(--gradient-matrix); color: black;">
                                                <i class="fas fa-users me-1"></i>{{ sala.jugadores_actuales }}/{{ sala.capacidad }}
                                            </span>
                                            <span class="badge" style="background: var(--gradient-sunset);">
                                                <i class="fas fa-coins me-1"></i>{{ sala.apuesta_minima }}€
                                            </span>
                                        </div>
                                        <small class="text-muted">Creada por: {{ sala.propietario.username }}</small>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <a href="{{ url_for('salas_multijugador_bp.sala', sala_id=sala.id) }}" class="btn btn-primary">
                                            <i class="fas fa-door-open me-2"></i>Unirse
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-door-closed fa-3x mb-3" style="color: var(--neon-cyan);"></i>
                    <h5>No hay salas disponibles</h5>
                    <p class="text-muted">Sé el primero en crear una sala y desafiar a otros jugadores</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Actualización automática de salas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    
    function actualizarSalas() {
        fetch('{{ url_for("api_multijugador.obtener_salas") }}')
            .then(response => response.json())
            .then(salas => {
                const container = document.getElementById('salas-container');
                if (salas.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-door-closed fa-3x mb-3" style="color: var(--neon-cyan);"></i>
                            <h5>No hay salas disponibles</h5>
                            <p class="text-muted">Sé el primero en crear una sala</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = salas.map(sala => `
                    <div class="col-12">
                        <div class="card hover-card translucent-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <h5 class="card-title">${sala.nombre}</h5>
                                        <div class="d-flex gap-3 mt-2">
                                            <span class="badge" style="background: var(--gradient-cyber);">
                                                <i class="fas fa-gamepad me-1"></i>${sala.juego}
                                            </span>
                                            <span class="badge" style="background: var(--gradient-matrix); color: black;">
                                                <i class="fas fa-users me-1"></i>${sala.jugadores_actuales}/${sala.capacidad}
                                            </span>
                                            <span class="badge" style="background: var(--gradient-sunset);">
                                                <i class="fas fa-coins me-1"></i>${sala.apuesta_minima}€
                                            </span>
                                        </div>
                                        <small class="text-muted">Creada por: ${sala.creador}</small>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <a href="/multijugador/sala/${sala.id}" class="btn btn-primary">
                                            <i class="fas fa-door-open me-2"></i>Unirse
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => console.error('Error actualizando salas:', error));
    }

    // Escuchar eventos de SocketIO para actualizaciones en tiempo real
    socket.on('user_joined', (data) => {
        console.log('Usuario se unió:', data);
        actualizarSalas();
    });

    socket.on('user_left', (data) => {
        console.log('Usuario salió:', data);
        actualizarSalas();
    });

    // Actualizar cada 5 segundos
    setInterval(actualizarSalas, 5000);
    actualizarSalas(); // Carga inicial
});
</script>
<script>
function actualizarCapacidad() {
    const juegoSelect = document.getElementById('select-juego');
    const capacidadSelect = document.getElementById('select-capacidad');
    const juego = juegoSelect.value;
    
    // Limpiar opciones actuales
    capacidadSelect.innerHTML = '';
    
    // Definir capacidades por juego
    let capacidades = [];
    switch(juego) {
        case 'coinflip':
            capacidades = [2];
            break;
        case 'caballos':
            capacidades = [4];
            break;
        case 'blackjack':
        case 'poker':
        case 'ruleta':
            capacidades = [2, 3, 4];
            break;
        default:
            capacidades = [2, 3, 4];
    }
    
    // Añadir opciones
    capacidades.forEach(cap => {
        const option = document.createElement('option');
        option.value = cap;
        option.textContent = `${cap} Jugadores`;
        if (cap === Math.max(...capacidades)) {
            option.selected = true;
        }
        capacidadSelect.appendChild(option);
    });
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarCapacidad();
});
</script>
{% endblock %}