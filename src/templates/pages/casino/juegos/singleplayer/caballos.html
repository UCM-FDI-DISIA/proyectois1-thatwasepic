{% extends "pages/casino/juegos/base.html" %}

{% block title %}
Carrera de caballos
{% endblock %}

{% block game_title %}
Carrera de caballos
{% endblock %}

{% set has_navbar_stats = true %}
{% block game_navbar_stats %}
<!-- Panel de Control -->
<div class="row">
    <div class="col">
        <div class="small text-center text-uppercase text-nowrap">
            <i class="fas fa-coins me-2"></i>Balance inicial
            <div class="h4 mb-0 balance-positive">
                $<span id="balance-inicial">{{ "%.2f"|format(current_user.balance) }}</span>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="small text-center text-uppercase text-nowrap">
            <i class="fas fa-info me-2"></i>Informaci√≥n
            <br>
            <button class="btn btn-outline-primary btn-sm" onclick="mostrarAyuda()">
                <i class="fas fa-question me-2"></i>Ayuda
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block content_fluid %}
<!-- Pista de carrera mejorada -->
<div class="row">
    <div class="pista-carrera mb-4">
        <div class="meta"></div>
        {% for i in range(1, 5) %}
        <div class="carril" id="carril{{ i }}">
            <div class="caballo" id="caballo{{ i }}">
                {{ ["üêé", "üê¥", "üèá", "üé†"][i-1] }}
            </div>
            <div class="numero">{{ i }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Selecci√≥n de apuesta -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="cantidad" class="form-label text-cyan">
                            <i class="fas fa-money-bill-wave me-2"></i>Cantidad a apostar:
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light">
                                <i class="fas fa-dollar-sign"></i>
                            </span>
                            <input type="number" class="form-control" id="cantidad" 
                                   min="1" max="{{ current_user.balance }}" step="1" value="10">
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label text-cyan">
                            <i class="fas fa-horse me-2"></i>Selecciona un caballo:
                        </label>
                        <div class="d-flex gap-2 flex-wrap">
                            {% for caballo in [
                                {"id": 1, "nombre": "Rel√°mpago", "multiplicador": 1.5, "emoji": "üêé", "color": "primary"},
                                {"id": 2, "nombre": "Trueno", "multiplicador": 2.0, "emoji": "üê¥", "color": "success"},
                                {"id": 3, "nombre": "Centella", "multiplicador": 3.0, "emoji": "üèá", "color": "danger"},
                                {"id": 4, "nombre": "Azabache", "multiplicador": 6.0, "emoji": "üé†", "color": "warning"}
                            ] %}
                            <button class="btn btn-outline-{{ caballo.color }} caballo-btn" 
                                    onclick="seleccionarCaballo({{ caballo.id }})">
                                {{ caballo.emoji }} {{ caballo.nombre }} ({{ caballo.multiplicador }}x)
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="text-center">
                    <button class="btn btn-primary btn-lg me-2" onclick="iniciarCarrera()" id="btn-carrera">
                        <i class="fas fa-flag-checkered me-2"></i>üèÅ Iniciar Carrera
                    </button>
                    <button class="btn btn-outline-primary btn-lg" onclick="reiniciarCarrera()">
                        <i class="fas fa-redo me-2"></i>üîÑ Reiniciar
                    </button>
                </div>

                <!-- Informaci√≥n de apuesta -->
                <div id="info-apuesta" class="text-center mt-3 fw-bold text-cyan"></div>
                
                <div id="resultado" class="mt-4"></div>
            </div>
        </div>
    </div>

    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                üèá INFORMACI√ìN DE LOS CABALLOS
            </div>
            <div class="card-body">
<!-- Informaci√≥n de caballos con cards mejoradas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-cyan mb-3">üèá INFORMACI√ìN DE LOS CABALLOS</h5>
                        <div class="row">
                            {% for caballo in [
                                {"id": 1, "nombre": "Rel√°mpago", "velocidad": 85, "resistencia": 70, "multiplicador": 1.5, "emoji": "üêé", "color": "primary"},
                                {"id": 2, "nombre": "Trueno", "velocidad": 75, "resistencia": 80, "multiplicador": 2.0, "emoji": "üê¥", "color": "success"},
                                {"id": 3, "nombre": "Centella", "velocidad": 65, "resistencia": 85, "multiplicador": 3.0, "emoji": "üèá", "color": "danger"},
                                {"id": 4, "nombre": "Azabache", "velocidad": 45, "resistencia": 95, "multiplicador": 6.0, "emoji": "üé†", "color": "warning"}
                            ] %}
                            <div class="col-md-3 mb-3">
                                <div class="card h-100 translucent-card">
                                    <div class="card-body text-center">
                                        <h5 class="text-{{ caballo.color }}">{{ caballo.emoji }} {{ caballo.nombre }}</h5>
                                        <div class="progress mb-2" style="height: 8px;">
                                            <div class="progress-bar bg-{{ caballo.color }}" role="progressbar" 
                                                 style="width: {{ caballo.velocidad }}%"></div>
                                        </div>
                                        <small>Velocidad: {{ caballo.velocidad }}%</small>
                                        <div class="progress mb-2" style="height: 8px;">
                                            <div class="progress-bar bg-info" role="progressbar" 
                                                 style="width: {{ caballo.resistencia }}%"></div>
                                        </div>
                                        <small>Resistencia: {{ caballo.resistencia }}%</small>
                                        <div class="mt-2">
                                            <span class="badge" style="background: var(--gradient-matrix); color: black;">
                                                Multiplicador: {{ caballo.multiplicador }}x
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ayuda con estilo cyber -->
<div class="modal fade" id="modalAyuda" tabindex="-1" aria-labelledby="modalAyudaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-cyan" id="modalAyudaLabel">
                    <i class="fas fa-horse me-2"></i>Ayuda - Carrera de Caballos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="text-pink">Descripci√≥n del juego "Carrera de Caballos"</h6>
                <p class="modal-description">
                    Comenzar√°s viendo tu balance actual y una secci√≥n con informaci√≥n de los cuatro caballos disponibles ‚ÄîRel√°mpago, Trueno, Centella y Azabache‚Äî, cada uno con su velocidad, resistencia y multiplicador de ganancia.
                </p>
                
                <h6 class="text-pink">A continuaci√≥n sigue estos pasos:</h6>
                <ol class="modal-description">
                    <li><strong>Elige la cantidad a apostar</strong> (limitada por tu saldo).</li>
                    <li><strong>Selecciona un caballo</strong> al que deseas apostar.</li>
                    <li><strong>Pulsa "Iniciar carrera"</strong> para comenzar la simulaci√≥n.</li>
                </ol>
                
                <p class="modal-description">
                    Una vez comience la carrera, los caballos avanzar√°n visualmente por una pista, con movimiento aleatorio ajustado seg√∫n su velocidad y resistencia. El primero en llegar a la meta se declarar√° ganador.
                </p>
                
                <h6 class="text-pink">Al finalizar:</h6>
                <ul class="modal-description">
                    <li>Si <strong>apostaste por el caballo ganador</strong>, se calcula tu ganancia multiplicando la apuesta por el multiplicador del caballo.</li>
                    <li>Si <strong>perdiste</strong> (ver√°s como esto no ocurre), se resta la cantidad apostada.</li>
                </ul>
                
                <p class="modal-description">
                    Siempre que quieras, podr√°s reiniciar la carrera para volver a jugar.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>Entendido
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let caballoSeleccionado = null;
let carreraEnCurso = false;

const caballos = {
    1: { nombre: "Rel√°mpago", multiplicador: 1.5, velocidad: 0.85, resistencia: 0.70, emoji: "üêé", color: "primary" },
    2: { nombre: "Trueno", multiplicador: 2.0, velocidad: 0.75, resistencia: 0.80, emoji: "üê¥", color: "success" },
    3: { nombre: "Centella", multiplicador: 3.0, velocidad: 0.65, resistencia: 0.85, emoji: "üèá", color: "danger" },
    4: { nombre: "Azabache", multiplicador: 6.0, velocidad: 0.45, resistencia: 0.95, emoji: "üé†", color: "warning" }
};

function mostrarAyuda() {
    new bootstrap.Modal(document.getElementById('modalAyuda')).show();
}

function calcularProbabilidades() {
    const puntuaciones = {};
    let total = 0;
    
    for (let i = 1; i <= 4; i++) {
        puntuaciones[i] = caballos[i].velocidad * 0.7 + caballos[i].resistencia * 0.3;
        total += puntuaciones[i];
    }
    
    const probabilidades = {};
    for (let i = 1; i <= 4; i++) {
        probabilidades[i] = puntuaciones[i] / total;
    }
    
    return probabilidades;
}

function seleccionarCaballo(numero) {
    if (carreraEnCurso) return;
    
    if (caballoSeleccionado === numero) {
        document.querySelectorAll('.caballo-btn, .caballo').forEach(el => el.classList.remove('caballo-seleccionado'));
        caballoSeleccionado = null;
        document.getElementById('info-apuesta').innerHTML = '';
        return;
    }
    
    caballoSeleccionado = numero;
    document.querySelectorAll('.caballo-btn, .caballo').forEach(el => el.classList.remove('caballo-seleccionado'));
    document.querySelector(`.caballo-btn:nth-child(${numero})`).classList.add('caballo-seleccionado');
    document.querySelector(`#carril${numero} .caballo`).classList.add('caballo-seleccionado');
    
    document.getElementById('info-apuesta').innerHTML = `
        <div class="alert alert-info text-center">
            <i class="fas fa-horse me-2"></i>
            Apuestas por: <strong>${caballos[numero].nombre}</strong> (${caballos[numero].multiplicador}x)
        </div>
    `;
}

function iniciarCarrera() {
    const cantidad = parseFloat(document.getElementById('cantidad').value);
    const balance = parseFloat('{{ current_user.balance }}');
    
    if (!caballoSeleccionado) return mostrarAlerta('Selecciona un caballo primero');
    if (!cantidad || cantidad <= 0) return mostrarAlerta('Ingresa una cantidad v√°lida');
    if (cantidad > balance) return mostrarAlerta('Fondos insuficientes');
    if (carreraEnCurso) return;
    
    carreraEnCurso = true;
    document.getElementById('btn-carrera').disabled = true;
    document.getElementById('resultado').innerHTML = '';
    
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`caballo${i}`).style.left = '0px';
    }
    
    const probabilidades = calcularProbabilidades();
    const velocidades = {};
    
    for (let i = 1; i <= 4; i++) {
        const baseSpeed = 2 + (caballos[i].velocidad * 3);
        velocidades[i] = baseSpeed * (0.5 + Math.random() * 1.5) * (0.8 + (probabilidades[i] * 0.4));
    }
    
    correrCarrera(velocidades, cantidad);
}

function mostrarAlerta(mensaje) {
    const alerta = `<div class="alert alert-warning alert-dismissible fade show text-center">
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    document.querySelector('.card-body').insertAdjacentHTML('afterbegin', alerta);
    setTimeout(() => document.querySelector('.alert')?.remove(), 3000);
}

function correrCarrera(velocidades, cantidad) {
    const meta = document.querySelector('.pista-carrera').offsetWidth - 60;
    let ganador = null;
    let posiciones = {1: 0, 2: 0, 3: 0, 4: 0};
    
    const intervalo = setInterval(() => {
        let todosLlegaron = true;
        
        for (let i = 1; i <= 4; i++) {
            if (posiciones[i] < meta) {
                todosLlegaron = false;
                posiciones[i] += velocidades[i] + Math.random() * 2;
                
                if (posiciones[i] >= meta) {
                    posiciones[i] = meta;
                    if (!ganador) ganador = i;
                }
                
                document.getElementById(`caballo${i}`).style.left = posiciones[i] + 'px';
            }
        }
        
        if (todosLlegaron) {
            clearInterval(intervalo);
            setTimeout(() => finalizarCarrera(ganador, cantidad), 1000);
        }
    }, 50);
}

function finalizarCarrera(ganador, cantidad) {
    const gano = ganador === caballoSeleccionado;
    const multiplicador = caballos[caballoSeleccionado].multiplicador;
    const ganancia = gano ? cantidad * multiplicador : 0;
    const caballoApostado = caballoSeleccionado; // Guardar antes de limpiar

    checkMotivationalMessage(gano ? 'ganada' : 'perdida');
    
    // Deseleccionar y resetear
    document.querySelectorAll('.caballo-btn, .caballo').forEach(el => el.classList.remove('caballo-seleccionado'));
    caballoSeleccionado = null;
    
    // Resaltar ganador
    document.getElementById(`caballo${ganador}`).classList.add('caballo-ganador');
    
    // Resultado centrado
    document.getElementById('resultado').innerHTML = `
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="alert ${gano ? 'alert-success' : 'alert-danger'} text-center">
                    <h4 class="mb-3">${gano ? '¬°GANASTE! üéâ' : 'Perdiste üòû'}</h4>
                    <p class="mb-2">Ganador: ${caballos[ganador].nombre} ${caballos[ganador].emoji}</p>
                    <p class="fw-bold mb-0 fs-5">${gano ? `Ganancia: $${ganancia.toFixed(2)} (${multiplicador}x)` : `Perdiste: $${cantidad.toFixed(2)}`}</p>
                </div>
            </div>
        </div>
    `;
    
    enviarResultadoCaballos(gano ? 'ganada' : 'perdida', cantidad, ganancia, caballoApostado, ganador);
    
    carreraEnCurso = false;
    document.getElementById('btn-carrera').disabled = false;
}

function reiniciarCarrera() {
    caballoSeleccionado = null;
    carreraEnCurso = false;
    
    document.querySelectorAll('.caballo-btn, .caballo').forEach(el => {
        el.classList.remove('caballo-seleccionado', 'caballo-ganador');
    });
    document.querySelectorAll('.caballo').forEach(caballo => {
        caballo.style.left = '0px';
    });
    
    document.getElementById('info-apuesta').innerHTML = '';
    document.getElementById('resultado').innerHTML = '';
    document.getElementById('btn-carrera').disabled = false;
}

function enviarResultadoCaballos(resultado, cantidad, ganancia, caballoApostado, caballoGanador) {
    console.log('üì§ Enviando resultado:', { resultado, cantidad, ganancia, caballoApostado, caballoGanador });
    
    fetch('/api/caballos/apostar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ cantidad, resultado, ganancia, caballo_apostado: caballoApostado, caballo_ganador: caballoGanador })
    })
    .then(res => {
        console.log('üì• Respuesta recibida:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('üì¶ Datos de respuesta:', data);
        if (data.error) {
            console.error('‚ùå Error en respuesta:', data.error);
            mostrarAlerta('Error: ' + data.error);
            return;
        }
        // Actualizar balance en UI
        if (data.nuevo_balance !== undefined) {
            console.log('üí∞ Actualizando balance:', data.nuevo_balance);
            document.getElementById('balance').textContent = data.nuevo_balance.toFixed(2);
            document.getElementById('cantidad').max = data.nuevo_balance;
        }
    })
    .catch(err => {
        console.error('‚ùå Error al procesar la apuesta:', err);
        mostrarAlerta('Error al procesar la apuesta: ' + err.message);
    });
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
           document.querySelector('input[name="csrf_token"]')?.value || '';
}

document.getElementById('cantidad').addEventListener('input', function() {
    const balance = parseFloat(document.getElementById('balance').textContent);
    if (parseFloat(this.value) > balance) this.value = balance;
});
</script>

<style>
/* Solo estilos espec√≠ficos de la carrera - el resto usa tus estilos globales */
.pista-carrera {
    background: linear-gradient(135deg, #1a5f2a 0%, #2d8f3f 50%, #1a5f2a 100%);
    border-top: 1px solid var(--neon-cyan);
    border-bottom: 1px solid var(--neon-cyan);
    padding: 15px;
    position: relative;
    height: 340px;
    overflow: hidden;
    background-attachment: fixed;
}

.pista-carrera::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        repeating-linear-gradient(90deg, rgba(20, 120, 40, 0.3) 0px, rgba(20, 120, 40, 0.3) 2px, transparent 2px, transparent 4px),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 2px);
    pointer-events: none;
    z-index: 1;
}

.meta {
    position: absolute;
    right: 5px;
    top: 5px;
    bottom: 5px;
    width: 8px;
    background: linear-gradient(180deg, var(--neon-yellow) 0%, var(--neon-orange) 50%, var(--neon-yellow) 100%);
    z-index: 2;
    box-shadow: var(--glow-yellow-button), inset 0 0 5px rgba(255,255,255,0.5);
    border-radius: 4px;
}

.carril {
    position: relative;
    height: 70px;
    margin: 8px 0;
    background: linear-gradient(90deg, 
        rgba(100, 200, 100, 0.2) 0%, 
        rgba(120, 220, 120, 0.3) 50%, 
        rgba(100, 200, 100, 0.2) 100%);
    border: 2px solid rgba(0, 243, 255, 0.4);
    border-radius: 8px;
    display: flex;
    align-items: center;
    padding: 0 10px;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.2);
    overflow: hidden;
    z-index: 2;
}

.carril:nth-child(odd) {
    background: linear-gradient(90deg, 
        rgba(80, 180, 80, 0.25) 0%, 
        rgba(100, 200, 100, 0.35) 50%, 
        rgba(80, 180, 80, 0.25) 100%);
}

.caballo {
    position: absolute;
    left: 10px;
    font-size: 2.8em;
    transition: left 0.1s linear;
    z-index: 3;
    filter: drop-shadow(0 0 8px rgba(0,0,0,0.6)) drop-shadow(0 0 3px rgba(255,255,255,0.3));
}

.numero {
    position: absolute;
    left: -35px;
    background: var(--gradient-cyber);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    z-index: 2;
    color: white;
    border: 2px solid var(--neon-cyan);
}

.caballo-btn {
    flex: 1;
    min-width: 120px;
    font-weight: bold;
}

/* Efectos de selecci√≥n usando tus variables */
.caballo-seleccionado {
    animation: seleccionadoPulse 1.5s ease-in-out infinite;
    filter: drop-shadow(0 0 15px currentColor) drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
}

.caballo-btn.caballo-seleccionado {
    animation: botonSeleccionado 2s ease-in-out infinite;
    transform: translateY(-2px);
    box-shadow: var(--glow-multi-button) !important;
}

.caballo-ganador {
    animation: ganadorPulse 1s infinite, glowWin 2s ease-in-out infinite;
}

/* Animaciones minimalistas */
@keyframes seleccionadoPulse {
    0%, 100% { 
        transform: scale(1);
        text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
    }
    50% { 
        transform: scale(1.15);
        text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
    }
}

@keyframes botonSeleccionado {
    0%, 100% { 
        box-shadow: var(--glow-multi-button);
    }
    50% { 
        box-shadow: 0 0 30px var(--neon-cyan), 0 0 40px var(--neon-pink);
    }
}

@keyframes ganadorPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes glowWin {
    0%, 100% { 
        text-shadow: 0 0 10px gold, 0 0 20px orange;
    }
    50% { 
        text-shadow: 0 0 20px gold, 0 0 40px orange;
    }
}
</style>
{% endblock %}